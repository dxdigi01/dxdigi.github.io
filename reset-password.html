<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ” Åifre SÄ±fÄ±rlama - DxDebt</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.3);
      padding:40px; max-width:400px; width:100%; text-align:center;
    }
    .icon { font-size:64px; margin-bottom:20px; }
    h1 { color:#333; margin-bottom:10px; font-size:24px; }
    .status { margin:30px 0; padding:20px; border-radius:12px; font-size:16px; }
    .loading { background:#e3f2fd; color:#1976d2; }
    .success { background:#e8f5e9; color:#388e3c; }
    .error { background:#ffebee; color:#d32f2f; }
    .button {
      display:inline-block; background:#667eea; color:#fff; padding:12px 30px;
      border-radius:8px; text-decoration:none; font-weight:600; margin-top:20px;
      border:none; cursor:pointer; font-size:16px; transition:background .3s;
    }
    .button:disabled { background:#ccc; cursor:not-allowed; }
    .token-info {
      margin-top:20px; padding:10px; background:#f5f5f5; border-radius:8px;
      font-size:12px; color:#666; word-break:break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">ğŸ”</div>
    <h1>Åifre SÄ±fÄ±rlama</h1>

    <div id="status" class="status loading">
      <span id="statusText">Mobil uygulamaya yÃ¶nlendiriliyorsunuz...</span>
    </div>

    <div id="tokenInfo" class="token-info" style="display:none;">
      Kod: <span id="tokenValue"></span>
    </div>

    <button id="openButton" class="button" disabled>DxDebt UygulamasÄ±nÄ± AÃ§</button>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const tokenInfo = document.getElementById('tokenInfo');
    const tokenValue = document.getElementById('tokenValue');
    const openButton = document.getElementById('openButton');

    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));

    const accessToken = hashParams.get('access_token') || urlParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token') || urlParams.get('refresh_token');
    const type = hashParams.get('type') || urlParams.get('type') || 'recovery';
    const code = urlParams.get('code') || hashParams.get('code');

    function setStatus(kind, text) {
      statusDiv.className = `status ${kind}`;
      statusText.textContent = text;
    }

    function buildDeepLink() {
      if (refreshToken) {
        // Supabase native flow: access+refresh fragment
        return `dxdebt://reset-password#access_token=${encodeURIComponent(accessToken || '')}`
             + `&refresh_token=${encodeURIComponent(refreshToken)}&type=${encodeURIComponent(type)}`;
      }
      if (accessToken) {
        return `dxdebt://reset-password#access_token=${encodeURIComponent(accessToken)}&type=${encodeURIComponent(type)}`;
      }
      if (code) {
        // PKCE fallback: app uses exchangeCodeForSession(code)
        return `dxdebt://reset-password?code=${encodeURIComponent(code)}`;
      }
      return null;
    }

    const deepLink = buildDeepLink();

    if (!deepLink) {
      setStatus('error', 'Token veya kod bulunamadÄ±. LÃ¼tfen linki tekrar aÃ§Ä±n.');
      openButton.disabled = true;
    } else {
      const preview = refreshToken || accessToken || code;
      tokenInfo.style.display = 'block';
      tokenValue.textContent = preview.substring(0, 30) + '...';

      const intentUrl = deepLink.startsWith('dxdebt://')
        ? deepLink.replace('dxdebt://', 'intent://').replace('#', '?')
          + '#Intent;scheme=dxdebt;package=com.dxdigi.dxdebt;end'
        : deepLink;

      function openApp(userInitiated) {
        window.location.href = deepLink;
        if (userInitiated) {
          setTimeout(() => {
            window.location.href = intentUrl;
          }, 300);
        }
      }

      openButton.disabled = false;
      openButton.onclick = () => openApp(true);

      // otomatik dene (Chrome engellerse kullanÄ±cÄ± butona dokunur)
      openApp(false);
      setStatus('success', 'Uygulama aÃ§Ä±lmazsa butona dokunun.');
    }
  </script>
</body>
</html>
