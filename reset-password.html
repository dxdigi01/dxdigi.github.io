<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ” Åifre SÄ±fÄ±rlama - DxDebt</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.3);
      padding:40px; max-width:400px; width:100%; text-align:center;
    }
    .icon { font-size:64px; margin-bottom:20px; }
    h1 { color:#333; margin-bottom:10px; font-size:24px; }
    .status { margin:30px 0; padding:20px; border-radius:12px; font-size:16px; }
    .loading { background:#e3f2fd; color:#1976d2; }
    .success { background:#e8f5e9; color:#388e3c; }
    .error { background:#ffebee; color:#d32f2f; }
    .spinner {
      display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3;
      border-top:3px solid #1976d2; border-radius:50%; animation:spin 1s linear infinite;
      margin-right:10px; vertical-align:middle;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .button {
      display:inline-block; background:#667eea; color:#fff; padding:12px 30px;
      border-radius:8px; text-decoration:none; font-weight:600; margin-top:20px;
      border:none; cursor:pointer; font-size:16px; transition:background .3s;
    }
    .button:hover { background:#5568d3; }
    .button:disabled { background:#ccc; cursor:not-allowed; }
    .token-info {
      margin-top:20px; padding:10px; background:#f5f5f5; border-radius:8px;
      font-size:12px; color:#666; word-break:break-all;
    }
    .footer { margin-top:30px; font-size:12px; color:#999; }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">ğŸ”</div>
    <h1>Åifre SÄ±fÄ±rlama</h1>

    <div id="status" class="status loading">
      <span class="spinner"></span>
      <span id="statusText">Mobil uygulamaya yÃ¶nlendiriliyorsunuz...</span>
    </div>

    <div id="tokenInfo" class="token-info" style="display:none;">
      Kod: <span id="tokenValue"></span>
    </div>

    <button id="openButton" class="button" disabled>ğŸ”“ DxDebt UygulamasÄ±nÄ± AÃ§</button>

    <div class="footer">
      <p>EÄŸer otomatik olarak yÃ¶nlendirilmezseniz, yukarÄ±daki butona tÄ±klayÄ±n.</p>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));

    const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
    const code = urlParams.get('code') || hashParams.get('code');

    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const tokenInfo = document.getElementById('tokenInfo');
    const tokenValue = document.getElementById('tokenValue');
    const openButton = document.getElementById('openButton');

    function showError(message) {
      statusDiv.className = 'status error';
      statusText.textContent = message;
      tokenInfo.style.display = 'none';
      openButton.disabled = true;
    }

    function tryOpenApp(payload) {
      if (!payload) return;
      const intentUrl = `intent://reset-password?code=${encodeURIComponent(payload)}#Intent;scheme=dxdebt;package=com.dxdigi.dxdebt;end`;
      window.location.href = intentUrl;
    }

    if (!code && !accessToken) {
      showError('Token bulunamadÄ±. LÃ¼tfen linki tekrar aÃ§Ä±n.');
    } else {
      const payload = code || accessToken;

      if (accessToken) {
        const session = {
          access_token: accessToken,
          token_type: 'bearer',
          expires_in: 3600,
          refresh_token: refreshToken || accessToken,
          user: { id:'', email:'', email_confirmed_at:new Date().toISOString() }
        };
        localStorage.setItem('supabase.auth.token', JSON.stringify(session));
      }

      tokenValue.textContent = payload.substring(0, 25) + '...';
      tokenInfo.style.display = 'block';

      openButton.disabled = false;
      openButton.onclick = () => tryOpenApp(payload);

      // Otomatik dene (Chrome izin vermezse kullanÄ±cÄ± butona basacak)
      tryOpenApp(payload);

      statusDiv.className = 'status success';
      statusText.textContent = 'Uygulama aÃ§Ä±lmadÄ±ysa butona dokunun.';
    }
  </script>
</body>
</html>
