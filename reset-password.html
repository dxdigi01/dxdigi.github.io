<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Åifre SÄ±fÄ±rlama - DxDebt</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;min-height:100vh;
       display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px}
  .card{background:#fff;border-radius:12px;padding:28px;max-width:420px;width:100%;text-align:center;box-shadow:0 20px 40px rgba(0,0,0,.18)}
  .icon{font-size:48px;margin-bottom:10px}
  h1{font-size:20px;color:#222;margin-bottom:6px}
  p.lead{color:#666;margin-bottom:20px}
  .status{padding:14px;border-radius:10px;margin-bottom:12px}
  .loading{background:#e3f2fd;color:#1565c0}
  .success{background:#e8f5e9;color:#2e7d32}
  .error{background:#ffebee;color:#c62828}
  .btn{display:inline-block;padding:12px 20px;border-radius:8px;background:#667eea;color:#fff;text-decoration:none;font-weight:600;border:none;cursor:pointer}
  .btn[disabled]{background:#bdbdbd;cursor:not-allowed}
  .small{font-size:12px;color:#888;margin-top:14px}
  .token{word-break:break-all;margin-top:8px;font-size:12px;color:#444;background:#f7f7f7;padding:8px;border-radius:8px}
</style>
</head>
<body>
  <div class="card" role="main">
    <div class="icon">ğŸ”</div>
    <h1>Åifre SÄ±fÄ±rlama</h1>
    <p class="lead">E-posta linkine tÄ±kladÄ±ÄŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼rler. UygulamanÄ±z aÃ§Ä±larak devam edeceksiniz.</p>

    <div id="status" class="status loading"><span id="statusText">Uygulamaya yÃ¶nlendiriliyorsunuz...</span></div>

    <div id="tokenBlock" style="display:none">
      <div class="token" id="tokenPreview"></div>
    </div>

    <button id="openBtn" class="btn" disabled>DxDebt UygulamasÄ±nÄ± AÃ§</button>

    <div class="small">EÄŸer otomatik aÃ§Ä±lmazsa butona dokunun. Bu sayfa <strong>token saklamaz</strong>.</div>
  </div>

<script>
(function(){
  const urlParams = new URLSearchParams(window.location.search);
  const fragParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
  const access = fragParams.get('access_token') || urlParams.get('access_token');
  const refresh = fragParams.get('refresh_token') || urlParams.get('refresh_token');
  const type = fragParams.get('type') || urlParams.get('type');
  const code = fragParams.get('code') || urlParams.get('code');

  const status = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const tokenBlock = document.getElementById('tokenBlock');
  const tokenPreview = document.getElementById('tokenPreview');
  const openBtn = document.getElementById('openBtn');

  function setState(cls, text){
    status.className = 'status ' + cls;
    statusText.textContent = text;
  }

  // Helper: build deep link using fragment (recommended)
  function buildDeepLink(accessToken, refreshToken, code, type) {
    // prefer refresh_token if available
    if (refreshToken) {
      return `dxdigi://reset#access_token=${encodeURIComponent(accessToken||'')}` +
             `&refresh_token=${encodeURIComponent(refreshToken)}` +
             `&type=${encodeURIComponent(type||'recovery')}`;
    }
    if (accessToken) {
      return `dxdigi://reset#access_token=${encodeURIComponent(accessToken)}&type=${encodeURIComponent(type||'recovery')}`;
    }
    if (code) {
      // code-based PKCE fallback (app must call exchangeCodeForSession)
      return `dxdigi://reset?code=${encodeURIComponent(code)}`;
    }
    return null;
  }

  const deepLink = buildDeepLink(access, refresh, code, type);

  if (!deepLink) {
    setState('error', 'Token veya kod bulunamadÄ±. LÃ¼tfen ÅŸifre sÄ±fÄ±rlama linkine tekrar tÄ±klayÄ±n.');
    openBtn.disabled = true;
    tokenBlock.style.display = 'none';
    return;
  }

  // show short preview (NOT the full token) for debugging/help (optional)
  tokenPreview.textContent = (refresh || access || code).substring(0, 30) + '...';
  tokenBlock.style.display = 'block';

  openBtn.disabled = false;
  openBtn.addEventListener('click', function(){
    tryOpen(deepLink, true);
  });

  // Try to open immediately
  tryOpen(deepLink, false);

  // Try to open app:
  function tryOpen(link, isUserActivated) {
    // 1) Standard URI scheme
    window.location.href = link;

    // 2) For Android Chrome fallback we can attempt intent URI (only when user activated or after small timeout)
    // Use this sparingly; some browsers block it when not user-initiated.
    if (isUserActivated) {
      // Build a safe intent fallback â€” note: fragment is not supported inside intent easily,
      // so use "S.browser_fallback_url" to preserve tokens on fallback to web if needed.
      try {
        const pkg = 'com.dxdigi.dxdebt'; // adjust to your package name
        // We include the fragment encoded in the fallback URL (so if browser falls back to web, it still has the fragment)
        const fallback = encodeURIComponent(window.location.href);
        const intentUri = `intent://reset#Intent;scheme=dxdigi;package=${pkg};S.browser_fallback_url=${fallback};end`;
        // Small delay to let scheme attempt; then set intent
        setTimeout(() => { window.location.href = intentUri; }, 300);
      } catch(e) {
        // ignore
      }
    }

    // Update UI
    setState('success', 'Uygulama aÃ§Ä±lmadÄ±ysa butona dokunun.');
  }
})();
</script>
</body>
</html>
