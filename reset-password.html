<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üîê ≈ûifre Sƒ±fƒ±rlama - DxDebt</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.3);
      padding:40px; max-width:400px; width:100%; text-align:center;
    }
    .icon { font-size:64px; margin-bottom:20px; }
    h1 { color:#333; margin-bottom:10px; font-size:24px; }
    .status { margin:30px 0; padding:20px; border-radius:12px; font-size:16px; }
    .loading { background:#e3f2fd; color:#1976d2; }
    .success { background:#e8f5e9; color:#388e3c; }
    .error { background:#ffebee; color:#d32f2f; }
    .spinner {
      display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3;
      border-top:3px solid #1976d2; border-radius:50%; animation:spin 1s linear infinite;
      margin-right:10px; vertical-align:middle;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .button {
      display:inline-block; background:#667eea; color:#fff; padding:12px 30px;
      border-radius:8px; text-decoration:none; font-weight:600; margin-top:20px;
      border:none; cursor:pointer; font-size:16px; transition:background .3s;
    }
    .button:hover { background:#5568d3; }
    .button:disabled { background:#ccc; cursor:not-allowed; }
    .token-info {
      margin-top:20px; padding:10px; background:#f5f5f5; border-radius:8px;
      font-size:12px; color:#666; word-break:break-all;
    }
    .footer { margin-top:30px; font-size:12px; color:#999; }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">üîê</div>
    <h1>≈ûifre Sƒ±fƒ±rlama</h1>

    <div id="status" class="status loading">
      <span class="spinner"></span>
      <span id="statusText">Mobil uygulamaya y√∂nlendiriliyorsunuz...</span>
    </div>

    <div id="tokenInfo" class="token-info" style="display:none;">
      Kod: <span id="tokenValue"></span>
    </div>

    <button id="fallbackButton" class="button" style="display:none;">Uygulamayƒ± A√ß</button>

    <div class="footer">
      <p>Eƒüer otomatik olarak y√∂nlendirilmezseniz, yukarƒ±daki butona tƒ±klayƒ±n.</p>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const hashParams = new URLSearchParams(window.location.hash.substring(1));

    // Supabase linkleri bazen ?code=... veya #access_token=... ≈üeklinde gelir
    const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
    const type = urlParams.get('type') || hashParams.get('type');
    const code = urlParams.get('code') || hashParams.get('code');

    console.log('üîç code:', code, 'type:', type, 'access:', accessToken ? accessToken.substring(0,15)+'...' : 'none');

    if (!code && !accessToken) {
      showError('Token bulunamadƒ±. L√ºtfen linki tekrar a√ßƒ±n.');
    } else {
      // Deep linke ge√ßmeden √∂nce Supabase session bilgisini localStorage‚Äôa yaz (web fallback i√ßin)
      if (accessToken) {
        const session = {
          access_token: accessToken,
          token_type: 'bearer',
          expires_in: 3600,
          refresh_token: refreshToken || accessToken,
          user: { id:'', email:'', email_confirmed_at:new Date().toISOString() }
        };
        localStorage.setItem('supabase.auth.token', JSON.stringify(session));
      }

      tokenValue.textContent = (code || accessToken || '').substring(0, 25) + '...';
      tokenInfo.style.display = 'block';
      openApp(code || accessToken);
    }

    function openApp(codeOrToken) {
      if (!codeOrToken) return;

      // Supabase mobile SDK, query string‚Äôde ?code=... bekliyor
      const deepLinkUrl = `dxdebt:///reset-password?code=${encodeURIComponent(codeOrToken)}`;
      const intentUrl = `intent://reset-password?code=${encodeURIComponent(codeOrToken)}#Intent;scheme=dxdebt;package=com.dxdigi.dxdebt;end`;

      console.log('üîó Deep link:', deepLinkUrl);
      console.log('üîó Intent URL:', intentUrl);

      // Android intent daha g√ºvenilir
      window.location.href = intentUrl;

      setTimeout(() => {
        statusDiv.className = 'status success';
        statusText.innerHTML = 'Eƒüer uygulama a√ßƒ±lmadƒ±ysa a≈üaƒüƒ±daki butondan tekrar deneyin.';
        fallbackButton.style.display = 'inline-block';
        fallbackButton.onclick = () => window.location.href = intentUrl;
      }, 1200);
    }

    function showError(message) {
      statusDiv.className = 'status error';
      statusText.textContent = message;
      tokenInfo.style.display = 'none';
      fallbackButton.style.display = 'none';
    }

    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const tokenInfo = document.getElementById('tokenInfo');
    const tokenValue = document.getElementById('tokenValue');
    const fallbackButton = document.getElementById('fallbackButton');
  </script>
</body>
</html>
